# Arkyn Time - Realm Integration
This repository contains information about the iOS-app Arkyn Time and how to write an integration for a custom backend through the synced Realm-database on the device.
## Overview
Arkyn Time is the first app from Arkyn Studios - a startup focused on creating "consumer grade" apps within the Smart Enterprise space i.e. apps built for large coorporations (primarily with SAP backends).
## System Design
The system has been designed with a couple goals in mind:
- The device must not be waiting on the backend for long-running queries, commands, etc. All actions on the device must be close instantaneous in order to provide a responsive interface.
- It should be easy to write integrations to other backends than SAP.
- When using SAP backends the system should be easy to configure and get up and running quick - without the need for extensive integration projects.

To accomodate these goals Realm is used as the database on the device and Realm Cloud to keep the on-device database synced with the backend.

Apart from Realm a service for onboarding users and authentication is provided by Arkyn Studios.

![Section example](system-design.png "Section example")
## Data Model
Most time registration systems are built around the same concept: employees make a registration on a day - either with a start- and end-time or with a fixed amount of time. Then they choose what the registration is related to - that could be a project, an order number, etc. We call this part of the registration `reporting`.

Since different time registration systems have slight variances in how this is done the data model for the app is designed in a backend-agnostic manner with the notion of `reporting trees`. Examples of such reporting trees could be:
- Order No.
- Work breakdown structures (WBS)
- Customers
- Project
- Phases
- Activities
- Kind - Billable, not billable, overtime, etc.
- ... and many other

Many of these will only be lists (trees with depth 1), but they can have any depth required.

A `reporting` is then defined as a selection of `reporting tree nodes` identifying which elements from each tree to register the entry on. An entry can be created based on a `reporting template` that defines which trees to use in a registration. That is done by defining a list of `reporting contexts`. Examples of reporting templates could be: "Project", "Absence", "Leave".

![Template example](example1.png "Template example")

In the above example the template defines two reporting contexts: WBS-number and activity. The finished reporting on the time entry is (in this case) `[947588800, 2115]` (Please note that in practice these will be uuids identifying each node and not their backend IDs as shown here fore the sake of simplicity).

Each reporting tree context can have a number of `reporting tree context sections`. This is a way to provide multiple ways to show the same data - for example by having a section with suggestions (generated by the backend) and a section with all elements.

![Section example](example2.png "Section example")

The backend integration must provide these trees, contexts, sections and templates in the device database - preferable tailored to the individual user to create a better user experience. See examples further down.

## Onboarding A New Device
This sections outlines what happens when the user opens the app for the first time.

1. The first time a user opens the app they are prompted for their mail-address which is posted to the Arkyn API. The API looks up which environment the user is associated with and triggers sends back the login-url for this environment along with a unique session-id for a websocket session.
2. This triggers the initialization of a new realm in Realm Cloud (if one does not already exist)
3. First the device must open the websocket connection, and then open the login-url at the Identity Provider (IdP) in a browser. This triggers an Oauth 2.0 code-flow.
4. The users logs in on the identity-provider, and a callback is called at the Arkyn API. The API then requests a token with the given code, and sends that token to the device on the open websocket.
5. Meanwhile the backend integration can initialize data in the user realm. When that is done a flag is set that the database is initialized and a message is sent to the device that all data is ready.

Happy path scenario for first time users:
```
     ┌─────────┐                            ┌────────────┐              ┌────────────┐           ┌─────────────┐               ┌─────────────────────┐
     │ App     │                            │ Arkyn API  │              │ IdP        │           │ Realm Cloud │               │ Backend integration │
     └────┬────┘                            └────┬───────┘              └────┬───────┘           └─────┬───────┘               └──────────┬──────────┘
          │     POST /register_device            ╎                           ╎  Initialize user realm  ╎                                  ╎
          ╎────────────────────────────────────> ║───────────────────────────────────────────────────> ╎  Detect change: new user realm   ╎
          ╎                                      ║                           ╎                         ╎┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄> ║ 
          ╎ <────────────────────────────────────╜                           ╎                         ╎                                  ║
          ╎     Response:                        ╎                           ╎                         ╎                                  ║
          ╎        login_url                     ╎                           ╎                         ╎                                  ║
          ╎        session_id                    ╎                           ╎                         ╎                                  ║
          ╎                                      ╎                           ╎                         ╎                                  ║
          ╎     Initiate WS with session id      ╎                           ╎                         ╎                                  ║
          ║────────────────────────────────────> ║       GET /authorize      ╎                         ╎                                  ║
          ║────────────────────────────────────────────────────────────────> ║                         ╎                                  ║
          ║                                      ║  Callback with auth code  ║                         ╎                                  ║
          ║                                      ║  <┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄╜                         ╎                                  ║
          ║                                      ║       POST /token         ╎                         ╎                                  ║
          ║                                      ║─────────────────────────> ║                         ╎                                  ║
          ║                                      ║      Response: token      ║                         ╎                                  ║
          ║                                      ║  <────────────────────────╜                         ╎                                  ║
┌╌╌╌╌╌┬╌╌╌╫╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╫╌╌╌╌┐                      ╎                         ╎                                  ║
╎ *   ╎   ║                                      ║    ╎                      ╎                         ╎                                  ║
├╌╌╌╌╌┘   ║ <┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄╢    ╎                      ╎                         ╎                                  ║
╎         ║ Upon token: Send JWT token to device ║    ╎                      ╎                         ╎                                  ║
╎         ║                                      ║    ╎                      ╎                         ╎                                  ║
└╌╌╌╌╌╌╌╌╌╫╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╫╌╌╌╌┘                      ╎                         ╎                                  ║
          ║                                      ║                           ╎                         ╎                                  ║
┌╌╌╌╌╌┬╌╌╌╫╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╫╌╌╌╌┐                      ╎                         ╎                                  ║
╎ *   ╎   ║                                      ║    ╎                      ╎                         ╎                                  ║
├╌╌╌╌╌┘   ║ <┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄╢    ╎                      ╎                         ╎                                  ║
╎         ║ Event: Realm initialized             ║    ╎                      ╎                         ╎                                  ║
╎         ║ Payload: Realm path                  ║    ╎                      ╎                         ╎                                  ║
└╌╌╌╌╌╌╌╌╌╫╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╫╌╌╌╌┘                      ╎                         ╎    Write user data done          ║
          ║                                      ║      Detect change        ╎                         ╎  <───────────────────────────────╜
┌╌╌╌╌╌┬╌╌╌╫╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╫╌╌╌╌┐ Write user data done ╎                         ╎                                  ╎
╎ *   ╎   ║                                      ║ <┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄╎                                  ╎
├╌╌╌╌╌┘   ║ <┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄╢    ╎                      ╎                         ╎                                  ╎
╎         ║ Event: Data ready                    ║    ╎                      ╎                         ╎                                  ╎
╎         ║                                      ║    ╎                      ╎                         ╎                                  ╎
└╌╌╌╌╌╌╌╌╌╫╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╫╌╌╌╌┘                      ╎                         ╎                                  ╎

```

## Integration

### Authentication
Authentication from the device towards Realm Cloud is done with a JWT-token issued by some identity-provider (e.g. Azure AD) with an authorization code flow initialized during the device onboarding. 

Realm will use the public key for that provider to verify the token and user identity.

Please use this guide to register an application:
https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app

The redirect-url to use is https://api.arkynstudios.com/auth_callback

### Backend Integration
The backend must connect to the Realm Cloud Platform. 

This can be done with Node.js, .NET or through a GraphQL API.

